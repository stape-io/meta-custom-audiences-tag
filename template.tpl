___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Meta/Facebook Custom Audiences by Stape",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Use this tag to send audience data to Meta\u0027s advertising products using the Marketing API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "audienceAction",
    "displayName": "Action",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "ingest",
        "displayValue": "Add to Audience"
      },
      {
        "value": "remove",
        "displayValue": "Remove from Audience"
      },
      {
        "value": "removeFromAll",
        "displayValue": "Remove from All Audiences"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "RADIO",
    "name": "authFlow",
    "displayName": "Authentication Type",
    "radioItems": [
      {
        "value": "own",
        "displayValue": "Own Meta Credentials",
        "help": "This type of auth is more complicated. It uses a combination of Meta App and System User to generate an Access Token.\n\u003cbr/\u003e\n⚠️ Meta enforces rate limits on API calls. Make sure your usage stays within these limits to avoid errors.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://github.com/stape-io/meta-custom-audiences-tag?tab\u003dreadme-ov-file#generating-a-system-user-access-token\"\u003eLearn more\u003c/a\u003e.",
        "subParams": []
      }
    ],
    "simpleValueType": true,
    "defaultValue": "own"
  },
  {
    "type": "GROUP",
    "name": "destinationsGroup",
    "subParams": [
      {
        "type": "GROUP",
        "name": "ownAuthDestinationsGroup",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "ownAuthAudiencesList",
            "displayName": "Destination Audiences",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Audience ID",
                "name": "audienceId",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  },
                  {
                    "type": "POSITIVE_NUMBER"
                  }
                ],
                "valueHint": "1234567890",
                "isUnique": true
              },
              {
                "defaultValue": "",
                "displayName": "Access Token",
                "name": "accessToken",
                "type": "TEXT",
                "valueHint": "EAAABCZCAnqewBPME6S...",
                "isUnique": false,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "newRowButtonText": "Add Audience",
            "help": "\u003cb\u003eAudience ID\u003c/b\u003e: The ID of the audience you want to interact with. You can find this in the Audiences panel within Ads Manager.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eAccess Token\u003c/b\u003e: A System User access token with the \u003ci\u003eads_management\u003c/i\u003e permission. This token must be associated with the Ad Account that owns the audience.\n\u003cbr/\u003e\nTo generate and use a valid access token, you’ll need:\n\u003cul\u003e \u003cli\u003eA Meta Business Manager account.\u003c/li\u003e \u003cli\u003eAdmin access to that Business Manager.\u003c/li\u003e \u003cli\u003eAn Ad Account connected to the Business Manager.\u003c/li\u003e \u003cli\u003eA Meta App: \u003cul\u003e \u003cli\u003eLinked to the same Business Manager\u003c/li\u003e \u003cli\u003eSet as an \u003ci\u003eApp Type\u003c/i\u003e of \u003ci\u003eBusiness\u003c/i\u003e\u003c/li\u003e \u003cli\u003eConfigured for the \u003ci\u003eMarketing API\u003c/i\u003e product\u003c/li\u003e \u003c/ul\u003e \u003c/li\u003e \u003cli\u003eA System User (Employee role is sufficient) with: \u003cul\u003e \u003cli\u003e\u003ci\u003eManage campaigns (ads)\u003c/i\u003e permission for the Ad Account\u003c/li\u003e \u003cli\u003e\u003ci\u003eDevelop app\u003c/i\u003e permission for the Meta App\u003c/li\u003e \u003c/ul\u003e \u003c/li\u003e \u003c/ul\u003e\n\u003ca href\u003d\"https://github.com/stape-io/meta-custom-audiences-tag?tab\u003dreadme-ov-file#generating-a-system-user-access-token\" target\u003d\"_blank\"\u003eLearn more\u003c/a\u003e.",
            "enablingConditions": [
              {
                "paramName": "audienceAction",
                "paramValue": "ingest",
                "type": "EQUALS"
              },
              {
                "paramName": "audienceAction",
                "paramValue": "remove",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "ownAuthAdAccountsList",
            "displayName": "Destination Ad Accounts",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Ad Account ID",
                "name": "adAccountId",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  },
                  {
                    "type": "POSITIVE_NUMBER"
                  }
                ],
                "valueHint": "1234567890",
                "isUnique": true
              },
              {
                "defaultValue": "",
                "displayName": "Access Token",
                "name": "accessToken",
                "type": "TEXT",
                "valueHint": "EAAABCZCAnqewBPME6S...",
                "isUnique": false,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "newRowButtonText": "Add Ad Account",
            "help": "\u003cb\u003eAd Account ID\u003c/b\u003e: The ID of the ad account where the audiences you want to interact with reside. You can find this within Ads Manager.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eAccess Token\u003c/b\u003e: A System User access token with the \u003ci\u003eads_management\u003c/i\u003e permission. This token must be associated with the Ad Account that owns the audience.\n\u003cbr/\u003e\nTo generate and use a valid access token, you’ll need:\n\u003cul\u003e \u003cli\u003eA Meta Business Manager account.\u003c/li\u003e \u003cli\u003eAdmin access to that Business Manager.\u003c/li\u003e \u003cli\u003eAn Ad Account connected to the Business Manager.\u003c/li\u003e \u003cli\u003eA Meta App: \u003cul\u003e \u003cli\u003eLinked to the same Business Manager\u003c/li\u003e \u003cli\u003eSet as an \u003ci\u003eApp Type\u003c/i\u003e of \u003ci\u003eBusiness\u003c/i\u003e\u003c/li\u003e \u003cli\u003eConfigured for the \u003ci\u003eMarketing API\u003c/i\u003e product\u003c/li\u003e \u003c/ul\u003e \u003c/li\u003e \u003cli\u003eA System User (Employee role is sufficient) with: \u003cul\u003e \u003cli\u003e\u003ci\u003eManage campaigns (ads)\u003c/i\u003e permission for the Ad Account\u003c/li\u003e \u003cli\u003e\u003ci\u003eDevelop app\u003c/i\u003e permission for the Meta App\u003c/li\u003e \u003c/ul\u003e \u003c/li\u003e \u003c/ul\u003e\n\u003ca href\u003d\"https://github.com/stape-io/meta-custom-audiences-tag?tab\u003dreadme-ov-file#generating-a-system-user-access-token\" target\u003d\"_blank\"\u003eLearn more\u003c/a\u003e.",
            "enablingConditions": [
              {
                "paramName": "audienceAction",
                "paramValue": "removeFromAll",
                "type": "EQUALS"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "authFlow",
            "paramValue": "own",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "groupStyle": "NO_ZIPPY"
  },
  {
    "type": "SELECT",
    "name": "useOptimisticScenario",
    "displayName": "Use Optimistic Scenario",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
    "defaultValue": false
  },
  {
    "type": "GROUP",
    "name": "audienceMembersGroup",
    "displayName": "Audience Members",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "userMode",
        "displayName": "User Mode",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "single",
            "displayValue": "Single User"
          },
          {
            "value": "multiple",
            "displayValue": "Multiple Users"
          }
        ],
        "simpleValueType": true,
        "help": "Send data for a single user or for multiple users.",
        "defaultValue": "single"
      },
      {
        "type": "GROUP",
        "name": "audienceMembersSingleUserGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "singleUserIdentifiersList",
            "displayName": "Single User Identifiers",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Identifier",
                "name": "name",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "DOBD",
                    "displayValue": "Birth Day"
                  },
                  {
                    "value": "DOBM",
                    "displayValue": "Birth Month"
                  },
                  {
                    "value": "DOBY",
                    "displayValue": "Birth Year"
                  },
                  {
                    "value": "CT",
                    "displayValue": "City"
                  },
                  {
                    "value": "COUNTRY",
                    "displayValue": "Country"
                  },
                  {
                    "value": "EMAIL",
                    "displayValue": "Email"
                  },
                  {
                    "value": "EXTERN_ID",
                    "displayValue": "External ID"
                  },
                  {
                    "value": "FN",
                    "displayValue": "First Name"
                  },
                  {
                    "value": "FI",
                    "displayValue": "First Name Initial"
                  },
                  {
                    "value": "GEN",
                    "displayValue": "Gender"
                  },
                  {
                    "value": "LN",
                    "displayValue": "Last Name"
                  },
                  {
                    "value": "MADID",
                    "displayValue": "Mobile Advertiser ID (IDFA/GAID)"
                  },
                  {
                    "value": "PHONE",
                    "displayValue": "Phone"
                  },
                  {
                    "value": "ST",
                    "displayValue": "State"
                  },
                  {
                    "value": "ZIP",
                    "displayValue": "ZIP/Postal Code"
                  }
                ],
                "isUnique": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "defaultValue": "",
                "displayName": "Value",
                "name": "value",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "newRowButtonText": "Add Identifier",
            "help": "For each Identifier field, specify a single value or an array of values. \u003cbr/\u003e Each item can be already SHA256 Hex hashed or not (the tag will hash it automatically). \u003cbr/\u003e The only execption is the \u003ci\u003eMobile Advertiser ID (IDFA/GAID)\u003c/i\u003e which must \u003cb\u003enot\u003c/b\u003e be hashed. \u003cbr/\u003e\u003cbr/\u003e If already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/audiences/guides/custom-audiences/#hash\"\u003enormalization guidelines\u003c/a\u003e before applying the hash."
          },
          {
            "type": "SELECT",
            "name": "enableDataProcessingOptions",
            "displayName": "Enable Data Processing Options",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": false,
                "displayValue": "false"
              },
              {
                "value": true,
                "displayValue": "true"
              }
            ],
            "simpleValueType": true,
            "subParams": [
              {
                "type": "SIMPLE_TABLE",
                "name": "singleUserDataProcessingOptionsList",
                "displayName": "Data Processing Options",
                "simpleTableColumns": [
                  {
                    "defaultValue": "",
                    "displayName": "Data Processing Options",
                    "name": "name",
                    "type": "SELECT",
                    "selectItems": [
                      {
                        "value": "DATA_PROCESSING_OPTIONS_COUNTRY",
                        "displayValue": "Data Processing Options Country"
                      },
                      {
                        "value": "DATA_PROCESSING_OPTIONS_STATE",
                        "displayValue": "Data Processing Options State"
                      }
                    ],
                    "valueValidators": [
                      {
                        "type": "NON_EMPTY"
                      }
                    ],
                    "isUnique": true
                  },
                  {
                    "defaultValue": "",
                    "displayName": "Value",
                    "name": "value",
                    "type": "TEXT",
                    "valueValidators": [
                      {
                        "type": "NON_EMPTY"
                      }
                    ]
                  }
                ],
                "help": "Limited Data Use is a data processing option that gives you more control over how your data is used in Meta’s systems and better supports your compliance efforts with various US state privacy regulations.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/overview/data-processing-options/#reference\"\u003eLearn more\u003c/a\u003e.",
                "newRowButtonText": "Add Data Processing Option",
                "enablingConditions": [
                  {
                    "paramName": "enableDataProcessingOptions",
                    "paramValue": false,
                    "type": "NOT_EQUALS"
                  }
                ]
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userMode",
            "paramValue": "single",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "audienceMembersMultipleUsersGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "multipleUsersSchema",
            "displayName": "Audience Members Identifiers Schema",
            "simpleValueType": true,
            "help": "Specify the Identifiers Schema using one of the following formats:\n\u003cul\u003e \u003cli\u003eA single identifier (e.g., \u003ci\u003eEMAIL\u003c/i\u003e)\u003c/li\u003e \u003cli\u003eA comma-separated string of identifiers (e.g., \u003ci\u003eFN,LN,EMAIL,EMAIL,PHONE\u003c/i\u003e)\u003c/li\u003e \u003cli\u003eAn array of identifiers (e.g., \u003ci\u003e[\"FN\", \"LN\", \"EMAIL\", \"EMAIL\", \"PHONE\"]\u003c/i\u003e)\u003c/li\u003e \u003c/ul\u003e \n\u003cbr/\u003e\nThe Identifiers Schema must exactly match the identifiers provided, same order and count.\n\u003cbr/\u003e\u003cbr/\u003e\nLearn more:\n\u003cul\u003e \u003cli\u003e\u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/reference/custom-audience/users/#parameters\" target\u003d\"_blank\"\u003eValid Identifier Schema values\u003c/a\u003e\u003c/li\u003e \u003cli\u003e\u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/audiences/guides/custom-audiences/#multikey\" target\u003d\"_blank\"\u003eExamples\u003c/a\u003e\u003c/li\u003e \u003c/ul\u003e",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "multipleUsersAudienceMembers",
            "displayName": "Audience Members Array",
            "simpleValueType": true,
            "help": "Specify the Audience Members array. This is useful when uploading data for multiple users in a single request. You can include up to 10000 audience members.\n\u003cbr/\u003e\u003cbr/\u003e\nThe array must follow the format defined in Meta’s documentation.\n\u003cbr/\u003e\u003cbr/\u003e \nIf the fields in the array are not SHA256 hashed, the tag will hash them automatically.\n\u003cbr/\u003e\u003cbr/\u003e \nReferences: \n\u003cul\u003e \n\u003cli\u003e\u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/audiences/guides/custom-audiences/#payload-fields\"\u003eAudience Member\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/audiences/guides/custom-audiences/#hash\"\u003eNormalization guidelines\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/audiences/guides/custom-audiences/#multikey\"\u003eExample\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userMode",
            "paramValue": "multiple",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "tagExecutionConsentSettingsGroup",
    "displayName": "Tag Execution Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr\u003e\u003cbr\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

/// <reference path="./server-gtm-sandboxed-apis.d.ts" />

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeString = require('makeString');
const Promise = require('Promise');
const Object = require('Object');
const sendHttpRequest = require('sendHttpRequest');
const sha256Sync = require('sha256Sync');

/*==============================================================================
==============================================================================*/

const eventData = getAllEventData();

const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const mappedData = getDataForAudienceDataUpload(data);

const invalidFields = validateMappedData(mappedData);
if (invalidFields) {
  log({
    Name: 'MetaCustomAudiences',
    Type: 'Message',
    EventName: data.audienceAction,
    Message: 'Request was not sent.',
    Reason: invalidFields
  });

  return data.gtmOnFailure();
}

sendRequests(data, mappedData);

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function addAudienceMembersData(data, mappedData) {
  let audienceMembers = [];
  let schema = [];

  if (data.userMode === 'single') {
    const audienceMember = [];

    data.singleUserIdentifiersList.forEach((identifier) => {
      const identifierValues = itemizeInput(identifier.value);
      identifierValues.forEach((identifierValue) => {
        schema.push(identifier.name);
        audienceMember.push(identifierValue);
      });
    });

    if (isUIFieldTrue(data.enableDataProcessingOptions)) {
      schema.push('DATA_PROCESSING_OPTIONS');
      audienceMember.push(['LDU']);

      if (data.singleUserDataProcessingOptionsList) {
        data.singleUserDataProcessingOptionsList.forEach((udpOption) => {
          let udpOptionValue = udpOption.value;
          if (!isValidValue(udpOptionValue)) return;
          udpOptionValue = makeInteger(udpOptionValue);
          schema.push(udpOption.name);
          audienceMember.push(udpOptionValue);
        });
      }
    }

    audienceMembers.push(audienceMember);
  } else if (data.userMode === 'multiple') {
    if (getType(data.multipleUsersAudienceMembers) === 'array') {
      audienceMembers = data.multipleUsersAudienceMembers;
    }

    const parsedSchema = parseSchemaInput(data.multipleUsersSchema);
    if (parsedSchema && parsedSchema.length > 0) {
      schema = parsedSchema;
    }
  }

  mappedData.payload.schema = schema;
  mappedData.payload.data = audienceMembers;

  return mappedData;
}

function hashDataIfNeeded(mappedData) {
  const audienceMembers = mappedData.payload.data;
  const schema = mappedData.payload.schema;
  const schemaType = getType(schema);
  const noHashIdentifiers = {
    DATA_PROCESSING_OPTIONS: true,
    DATA_PROCESSING_OPTIONS_COUNTRY: true,
    DATA_PROCESSING_OPTIONS_STATE: true,
    MADID: true
  };
  const processIdentifier = (schema, identifier, index, identifiersArray) => {
    if (noHashIdentifiers[schema]) return;
    const normalizedIdentifier = normalizeBasedOnSchemaKey(schema, identifier);
    identifiersArray[index] = hashData(normalizedIdentifier);
  };

  if (audienceMembers && schema) {
    audienceMembers.forEach((audienceMember, i) => {
      if (!audienceMember) return;

      const audienceMemberType = getType(audienceMember);

      if (audienceMemberType === 'string') {
        processIdentifier(schema, audienceMember, i, audienceMembers);
      } else if (audienceMemberType === 'array') {
        audienceMember.forEach((identifier, j) => {
          if (!identifier) return;
          processIdentifier(
            schemaType === 'array' ? schema[j] : schema,
            identifier,
            j,
            audienceMember
          );
        });
      }
    });
  }

  return mappedData;
}

function getDataForAudienceDataUpload(data) {
  const mappedData = {
    payload: {}
  };

  addAudienceMembersData(data, mappedData);
  hashDataIfNeeded(mappedData);

  return mappedData;
}

function validateMappedData(mappedData) {
  if (!mappedData.payload.schema || mappedData.payload.schema.length === 0) {
    return 'The Audience Members Identifiers Schema must be specified.';
  }

  if (!mappedData.payload.data || mappedData.payload.data.length === 0) {
    return 'At least 1 Audience Member must be specified.';
  }

  const audienceMembersLengthLimit = 10000;
  if (mappedData.payload.data.length > audienceMembersLengthLimit) {
    return (
      'Audience Members list length must be at most ' +
      audienceMembersLengthLimit +
      '. Current is: ' +
      mappedData.payload.data.length
    );
  }
}

function getDestinations(data) {
  const authFlow = data.authFlow === 'own';
  const audiencesList = authFlow ? data.ownAuthAudiencesList : data.stapeAuthAudiencesList;
  const adAccountsList = authFlow ? data.ownAuthAdAccountsList : data.stapeAuthAdAccountsList;

  return data.audienceAction === 'removeFromAll' ? adAccountsList : audiencesList;
}

function generateRequestUrl(data, config) {
  const apiVersion = '23.0';
  const baseUrl = 'https://graph.facebook.com/v' + apiVersion;

  let audiencePath;
  switch (data.audienceAction) {
    case 'ingest':
    case 'remove':
      audiencePath = '/' + enc(config.audienceId) + '/users';
      break;
    case 'removeFromAll':
      audiencePath = '/act_' + enc(config.adAccountId) + '/usersofanyaudience';
      break;
  }

  const requestUrl = baseUrl + audiencePath + '?access_token=' + enc(config.accessToken);

  return requestUrl;
}

function generateRequestOptions(data) {
  const requestMethodByAudienceAction = {
    ingest: 'POST',
    remove: 'DELETE',
    removeFromAll: 'DELETE'
  };
  const requestMethod = requestMethodByAudienceAction[data.audienceAction];

  const options = {
    method: requestMethod,
    headers: {
      'Content-Type': 'application/json'
    }
  };

  return options;
}

function sendRequests(data, mappedData) {
  const destinations = getDestinations(data);
  const requestOptions = generateRequestOptions(data);

  const requests = destinations.map((d) => {
    const requestUrl = generateRequestUrl(data, {
      audienceId: d.audienceId,
      adAccountId: d.adAccountId,
      accessToken: d.accessToken
    });

    log({
      Name: 'MetaCustomAudiences',
      Type: 'Request',
      EventName: data.audienceAction,
      RequestMethod: requestOptions.method,
      RequestUrl: requestUrl,
      RequestBody: mappedData
    });

    return sendHttpRequest(requestUrl, requestOptions, JSON.stringify(mappedData));
  });

  Promise.all(requests)
    .then((results) => {
      let someRequestFailed = false;

      results.forEach((result) => {
        log({
          Name: 'MetaCustomAudiences',
          Type: 'Response',
          EventName: data.audienceAction,
          ResponseStatusCode: result.statusCode,
          ResponseHeaders: result.headers,
          ResponseBody: result.body
        });

        if (result.statusCode < 200 || result.statusCode >= 300) {
          someRequestFailed = true;
        }
      });

      if (!useOptimisticScenario) {
        if (someRequestFailed) data.gtmOnFailure();
        else data.gtmOnSuccess();
      }
    })
    .catch((result) => {
      log({
        Name: 'MetaCustomAudiences',
        Type: 'Message',
        EventName: data.audienceAction,
        Message: 'Some request failed or timed out.',
        Reason: JSON.stringify(result)
      });

      if (!useOptimisticScenario) data.gtmOnFailure();
    });
}

/*==============================================================================
  Helpers
==============================================================================*/

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function parseSchemaInput(input) {
  const type = getType(input);
  if (!isValidValue(input)) return;
  else if (type === 'array') return input.filter((e) => e);
  else if (type === 'string') {
    const split = input.split(',');
    return split.length === 1 ? input : split;
  }
}

function normalizePhoneNumber(phoneNumber) {
  if (!phoneNumber) return phoneNumber;
  return phoneNumber
    .split('+')
    .join('')
    .split(' ')
    .join('')
    .split('-')
    .join('')
    .split('(')
    .join('')
    .split(')')
    .join('');
}

function removeWhiteSpace(input) {
  if (!input) return input;
  return input.split(' ').join('');
}

function isHashed(value) {
  if (!value) return false;
  return makeString(value).match('^[A-Fa-f0-9]{64}$') !== null;
}

function hashData(value) {
  if (!value) return value;

  const type = getType(value);

  if (value === 'undefined' || value === 'null') return undefined;

  if (type === 'array') {
    return value.map((val) => hashData(val));
  }

  if (type === 'object') {
    return Object.keys(value).reduce((acc, val) => {
      acc[val] = hashData(value[val]);
      return acc;
    }, {});
  }

  if (isHashed(value)) return value;

  return sha256Sync(makeString(value).trim().toLowerCase(), {
    outputEncoding: 'hex'
  });
}

function normalizeBasedOnSchemaKey(schemaKey, identifier) {
  if (schemaKey === 'PHONE') return normalizePhoneNumber(identifier);
  else if (schemaKey === 'CT' || schemaKey === 'ST' || schemaKey === 'ZIP') {
    return removeWhiteSpace(identifier);
  } else return identifier;
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function itemizeInput(input) {
  const type = getType(input);
  if (type === 'array') return input.filter((e) => e);
  else if (type === 'string') return [input];
  return [];
}

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  rawDataToLog.TraceId = getRequestHeader('trace-id');

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  BigQuery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://graph.facebook.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[Single User] Should NOT send request if Audience Schema or Audience Members
    list is empty'
  code: |-
    setMockDataByAudienceMethod('ingest', {
      userMode: 'single',
      singleUserIdentifiersList: [],
      enableDataProcessingOptions: false,
      singleUserDataProcessingOptionsList: undefined
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: '[Multiple Users] Should NOT send request if Audience Schema list is empty'
  code: |-
    setMockDataByAudienceMethod('ingest', {
      userMode: 'multiple',
      multipleUsersSchema: [],
      singleUserIdentifiersList: undefined,
      enableDataProcessingOptions: undefined,
      singleUserDataProcessingOptionsList: undefined
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: '[Multiple Users] Should NOT send request if Audience Members list is empty'
  code: |-
    setMockDataByAudienceMethod('ingest', {
      userMode: 'multiple',
      multipleUsersAudienceMembers: [],
      singleUserIdentifiersList: undefined,
      enableDataProcessingOptions: undefined,
      singleUserDataProcessingOptionsList: undefined
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: '[Multiple Users] Should NOT send request if Audience Members list length
    is greater than 10000'
  code: |-
    const audienceMembers = ['bar'];
    audienceMembers.length = 10001;

    setMockDataByAudienceMethod('ingest', {
      userMode: 'multiple',
      multipleUsersAudienceMembers: audienceMembers,
      singleUserIdentifiersList: undefined,
      enableDataProcessingOptions: undefined,
      singleUserDataProcessingOptionsList: undefined
    });

    runCode(mockData);

    assertApi('sendHttpRequest').wasNotCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: '[Ingest] Request URL, Request Options and Request Body are succesfully built
    and sent'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'single'\n});\n\nmockData.ownAuthAudiencesList.push({\n\
    \  audienceId: 'expectedAudienceId2',\n  accessToken: 'expectedAccessToken2'\n\
    });\n\nlet requestCount = 0;\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  assertThat(requestUrl).isEqualTo(\n    'https://graph.facebook.com/v'\
    \ + apiVersion + '/' + mockData.ownAuthAudiencesList[requestCount].audienceId\
    \ + '/users?access_token=' + mockData.ownAuthAudiencesList[requestCount].accessToken\n\
    \  );\n\n  assertThat(requestOptions).isEqualTo({\n    method: 'POST',\n    headers:\
    \ { 'Content-Type': 'application/json' }\n  });\n  \n  const parsedRequestBody\
    \ = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo(singleUserExpectedRequestBody);\n\
    \  \n  requestCount++;\n  \n  return Promise.create((resolve, reject) => {\n \
    \   resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Remove] Request URL, Request Options and Request Body are succesfully built
    and sent'
  code: "setMockDataByAudienceMethod('remove', {\n  userMode: 'single'\n});\n\nmockData.ownAuthAudiencesList.push({\n\
    \  audienceId: 'expectedAudienceId2',\n  accessToken: 'expectedAccessToken2'\n\
    });\n\nlet requestCount = 0;\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  assertThat(requestUrl).isEqualTo(\n    'https://graph.facebook.com/v'\
    \ + apiVersion + '/' + mockData.ownAuthAudiencesList[requestCount].audienceId\
    \ + '/users?access_token=' + mockData.ownAuthAudiencesList[requestCount].accessToken\n\
    \  );\n\n  assertThat(requestOptions).isEqualTo({\n    method: 'DELETE',\n   \
    \ headers: { 'Content-Type': 'application/json' }\n  });\n  \n  const parsedRequestBody\
    \ = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo(singleUserExpectedRequestBody);\n\
    \  \n  requestCount++;\n  \n  return Promise.create((resolve, reject) => {\n \
    \   resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Remove from All] Request URL, Request Options and Request Body are succesfully
    built and sent'
  code: "setMockDataByAudienceMethod('removeFromAll', {\n  userMode: 'single'\n});\n\
    \nmockData.ownAuthAdAccountsList.push({\n  adAccountId: 'expectedAdAccountId2',\n\
    \  accessToken: 'expectedAccessToken2'\n});\n\nlet requestCount = 0;\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  assertThat(requestUrl).isEqualTo(\n\
    \    'https://graph.facebook.com/v' + apiVersion + '/act_' + mockData.ownAuthAdAccountsList[requestCount].adAccountId\
    \ + '/usersofanyaudience?access_token=' + mockData.ownAuthAdAccountsList[requestCount].accessToken\n\
    \  );\n\n  assertThat(requestOptions).isEqualTo({\n    method: 'DELETE',\n   \
    \ headers: { 'Content-Type': 'application/json' }\n  });\n  \n  const parsedRequestBody\
    \ = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo(singleUserExpectedRequestBody);\n\
    \  \n  requestCount++;\n  \n  return Promise.create((resolve, reject) => {\n \
    \   resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Ingest - Multiple Users] Request Body is successfully built and sent'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'multiple',\n  singleUserIdentifiersList:\
    \ undefined,\n  enableDataProcessingOptions: undefined,\n  singleUserDataProcessingOptionsList:\
    \ undefined\n});\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {\n  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo(multipleUsersExpectedRequestBody);\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Remove - Multiple Users] Request Body is successfully built and sent'
  code: "setMockDataByAudienceMethod('remove', {\n  userMode: 'multiple',\n  singleUserIdentifiersList:\
    \ undefined,\n  enableDataProcessingOptions: undefined,\n  singleUserDataProcessingOptionsList:\
    \ undefined\n});\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {\n  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo(multipleUsersExpectedRequestBody);\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Remove from All - Multiple Users] Request Body is successfully built and
    sent'
  code: "setMockDataByAudienceMethod('removeFromAll', {\n  userMode: 'multiple',\n\
    \  singleUserIdentifiersList: undefined,\n  enableDataProcessingOptions: undefined,\n\
    \  singleUserDataProcessingOptionsList: undefined\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo(multipleUsersExpectedRequestBody);\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Multiple Users] Audience Schema as single item string'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'multiple',\n  multipleUsersSchema:\
    \ 'EMAIL',\n  multipleUsersAudienceMembers: ['test', 'test'],\n  singleUserIdentifiersList:\
    \ undefined,\n  enableDataProcessingOptions: undefined,\n  singleUserDataProcessingOptionsList:\
    \ undefined\n});\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {\n  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody.payload.schema).isEqualTo('EMAIL');\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Multiple Users] Audience Schema as comma-separated string'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'multiple',\n  multipleUsersSchema:\
    \ 'EMAIL,PHONE',\n  singleUserIdentifiersList: undefined,\n  enableDataProcessingOptions:\
    \ undefined,\n  singleUserDataProcessingOptionsList: undefined\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody.payload.schema).isEqualTo(['EMAIL',\
    \ 'PHONE']);\n\n  return Promise.create((resolve, reject) => {\n    resolve({\
    \ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Multiple Users] Audience Schema as array'
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'multiple',\n  multipleUsersSchema:\
    \ ['EMAIL', 'PHONE'],\n  multipleUsersAudienceMembers: [['test', 'test'], ['test',\
    \ 'test']],\n  singleUserIdentifiersList: undefined,\n  enableDataProcessingOptions:\
    \ undefined,\n  singleUserDataProcessingOptionsList: undefined\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody.payload.schema).isEqualTo(['EMAIL',\
    \ 'PHONE']);\n\n  return Promise.create((resolve, reject) => {\n    resolve({\
    \ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: gtmOnFailure handler is called if some response fails with status code
  code: "setMockDataByAudienceMethod('ingest', {\n  userMode: 'single'\n});\n\nmockData.ownAuthAudiencesList.push({\n\
    \  audienceId: 'expectedAudienceId2',\n  accessToken: 'expectedAccessToken2'\n\
    });\n\nlet requestCount = 0;\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  requestCount++;\n  return Promise.create((resolve, reject)\
    \ => {\n    resolve({ statusCode: (requestCount === mockData.ownAuthAudiencesList.length\
    \ - 1) ? 500 : 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() =>\
    \ {\n  assertApi('gtmOnSuccess').wasNotCalled();\n  assertApi('gtmOnFailure').wasCalled();\n\
    });"
- name: gtmOnFailure handler is called if some response rejects
  code: |-
    setMockDataByAudienceMethod('ingest', {
      userMode: 'single'
    });

    mockData.ownAuthAudiencesList.push({
      audienceId: 'expectedAudienceId2',
      accessToken: 'expectedAccessToken2'
    });

    mock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => { });

    mockObject('Promise', {
      all: () => Promise.create((resolve, reject) => reject({ reason: 'failed' }))
    });

    runCode(mockData);

    callLater(() => {
      assertApi('gtmOnSuccess').wasNotCalled();
      assertApi('gtmOnFailure').wasCalled();
    });
- name: '[Logs] Should log to console'
  code: "const originalMockData = setMockDataByAudienceMethod('ingest');\n\n[\n  //\
    \ if the 'Always log to console' option is selected\n  { mockData: { logType:\
    \ 'always' }, expectedDebugMode: true },\n  // if the 'Log during debug and preview'\
    \ option is selected AND is on preview mode\n  { mockData: { logType: 'debug'\
    \ }, expectedDebugMode: true },\n].forEach(scenario => {\n  const copyMockData\
    \ = JSON.parse(JSON.stringify(originalMockData));\n  mergeObj(copyMockData, scenario.mockData);\n\
    \  \n  mock('getContainerVersion', () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n\
    \    };\n  }); \n  \n  mock('logToConsole', (logData) => {\n    const parsedLogData\
    \ = JSON.parse(logData);\n    requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());\n\
    \  });\n  \n  runCode(copyMockData);\n  \n  callLater(() => {\n    assertApi('logToConsole').wasCalled();\n\
    \    assertApi('gtmOnSuccess').wasCalled();\n    assertApi('gtmOnFailure').wasNotCalled();\n\
    \  });\n});"
- name: '[Logs] Should NOT log to console'
  code: "const originalMockData = setMockDataByAudienceMethod('ingest');\n\n[\n  //\
    \ if the 'Log during debug and preview' option is selected AND is NOT on preview\
    \ mode\n  { mockData: { logType: 'debug' }, expectedDebugMode: false },\n  //\
    \ if the 'Do not log' option is selected\n  { mockData: { logType: 'no' }, expectedDebugMode:\
    \ undefined },\n].forEach(scenario => {\n  const copyMockData = JSON.parse(JSON.stringify(originalMockData));\n\
    \  mergeObj(copyMockData, scenario.mockData);\n  \n  mock('getContainerVersion',\
    \ () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n    };\n\
    \  });\n  \n  runCode(copyMockData);\n\n  callLater(() => {\n    assertApi('logToConsole').wasNotCalled();\n\
    \    assertApi('gtmOnSuccess').wasCalled();\n    assertApi('gtmOnFailure').wasNotCalled();\n\
    \  });\n});"
- name: '[Logs] Should log to BQ, if the ''Log to BigQuery'' option is selected'
  code: "setMockDataByAudienceMethod('ingest');\n\nmockData.bigQueryLogType = 'always';\n\
    \nmockObject('BigQuery', {\n  insert: (connectionInfo, rows, options) => { \n\
    \    assertThat(connectionInfo).isDefined();\n    assertThat(rows).isArray();\n\
    \    assertThat(rows).hasLength(1);\n    requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \    assertThat(options).isEqualTo(expectedBqOptions);\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve();\n    });\n  }\n});\n\nrunCode(mockData);\n\n\
    callLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Logs] Should NOT log to BQ, if the ''Do not log to BigQuery'' option is
    selected'
  code: "setMockDataByAudienceMethod('ingest');\n\nmockData.bigQueryLogType = 'no';\n\
    \n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mockObject('BigQuery', {\n  insert: (connectionInfo, rows, options) => { \n  \
    \  fail('BigQuery.insert should not have been called.');\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve();\n    });\n  }\n});\n\nrunCode(mockData);\n\n\
    callLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
setup: "const Promise = require('Promise');\nconst JSON = require('JSON');\nconst\
  \ makeInteger = require('makeInteger');\nconst Object = require('Object');\nconst\
  \ callLater = require('callLater');\n\nconst mergeObj = (target, source) => {\n\
  \  for (const key in source) {\n    if (source.hasOwnProperty(key)) target[key]\
  \ = source[key];\n  }\n  return target;\n};\n\nconst apiVersion = '23.0';\n\nconst\
  \ singleUserExpectedRequestBody = {\n  payload: {\n    schema: [\n      'DOBD',\n\
  \      'DOBM',\n      'DOBY',\n      'CT',\n      'COUNTRY',\n      'EMAIL',\n \
  \     'EXTERN_ID',\n      'FN',\n      'FI',\n      'GEN',\n      'LN',\n      'MADID',\n\
  \      'PHONE',\n      'ST',\n      'ZIP',\n      'DATA_PROCESSING_OPTIONS',\n \
  \     'DATA_PROCESSING_OPTIONS_COUNTRY',\n      'DATA_PROCESSING_OPTIONS_STATE'\n\
  \    ],\n    data: [\n      [\n        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
  \        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n \
  \       '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n  \
  \      '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n   \
  \     '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n    \
  \    '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n     \
  \   '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n      \
  \  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n       \
  \ '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
  \        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n \
  \       'test',\n        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
  \        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n \
  \       '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n  \
  \      ['LDU'],\n        1,\n        1000\n      ]\n    ]\n  }\n};\n\nconst multipleUsersExpectedRequestBody\
  \ = {\n  payload: {\n    schema: ['EMAIL', 'PHONE'],\n    data: [\n      [\n   \
  \     '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n    \
  \    '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n      ],\n\
  \      [\n        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
  \        '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\n  \
  \    ]\n    ]\n  }\n};\n\nconst expectedBigQuerySettings = {\n  logBigQueryProjectId:\
  \ 'logBigQueryProjectId',\n  logBigQueryDatasetId: 'logBigQueryDatasetId',\n  logBigQueryTableId:\
  \ 'logBigQueryTableId'\n};\n\nconst requiredConsoleKeys = ['Type', 'TraceId', 'Name'];\n\
  const requiredBqKeys = ['timestamp', 'type', 'trace_id', 'tag_name'];\nconst expectedBqOptions\
  \ = { ignoreUnknownValues: true };\n\nconst mockData = {\n  logBigQueryProjectId:\
  \ expectedBigQuerySettings.logBigQueryProjectId,\n  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n\
  \  logBigQueryTableId: expectedBigQuerySettings.logBigQueryTableId\n};\n\nconst\
  \ setMockDataByAudienceMethod = (method, objToBeMerged) => {\n  const baseMockData\
  \ = {\n    useOptimisticScenario: false,\n    userMode: 'single',\n    singleUserIdentifiersList:\
  \ [\n      { name: 'DOBD', value: 'test' },\n      { name: 'DOBM', value: 'test'\
  \ },\n      { name: 'DOBY', value: 'test' },\n      { name: 'CT', value: 'test'\
  \ },\n      { name: 'COUNTRY', value: 'test' },\n      { name: 'EMAIL', value: 'test'\
  \ },\n      { name: 'EXTERN_ID', value: 'test' },\n      { name: 'FN', value: 'test'\
  \ },\n      { name: 'FI', value: 'test' },\n      { name: 'GEN', value: 'test' },\n\
  \      { name: 'LN', value: 'test' },\n      { name: 'MADID', value: 'test' },\n\
  \      { name: 'PHONE', value: 'test' },\n      { name: 'ST', value: 'test' },\n\
  \      { name: 'ZIP', value: 'test' }\n    ],\n    enableDataProcessingOptions:\
  \ true,\n    singleUserDataProcessingOptionsList: [\n      { name: 'DATA_PROCESSING_OPTIONS_COUNTRY',\
  \ value: '1' },\n      { name: 'DATA_PROCESSING_OPTIONS_STATE', value: '1000' }\n\
  \    ],\n    \n    // Multiple Users. It won't be used by the single user case.\
  \ It's here to make testing easier.\n    multipleUsersSchema: ['EMAIL', 'PHONE'],\n\
  \    multipleUsersAudienceMembers: [['test', 'test'], ['test', 'test']],\n    \n\
  \    adStorageConsent: 'optional',\n    logType: 'debug',\n    bigQueryLogType:\
  \ 'no',\n  };\n  \n  const methods = {\n    ingest: {\n      authFlow: 'own',\n\
  \      audienceAction: 'ingest',\n      ownAuthAudiencesList: [\n        {\n   \
  \       audienceId: 'expectedAudienceId',\n          accessToken:\n            'expectedAccessToken'\n\
  \        }\n      ]\n    },\n    remove: {\n      authFlow: 'own',\n      audienceAction:\
  \ 'remove',\n      ownAuthAudiencesList: [\n        {\n          audienceId: 'expectedAudienceId',\n\
  \          accessToken:\n            'expectedAccessToken'\n        }\n      ]\n\
  \    },\n    removeFromAll: {\n      authFlow: 'own',\n      audienceAction: 'removeFromAll',\n\
  \      ownAuthAdAccountsList: [\n        {\n          adAccountId: 'expectedAdAccountId',\n\
  \          accessToken: 'expectedAccessToken'\n        }\n      ]\n    }\n  };\n\
  \  \n  return mergeObj(\n    mockData, \n    mergeObj(\n      methods[method], \n\
  \      mergeObj(baseMockData, objToBeMerged || {})\n    )\n  );\n};\n\nconst setGetAllEventData\
  \ = (objToBeMerged) => {\n  mock('getAllEventData', mergeObj({\n    'x-ga-protocol_version':\
  \ '2',\n    'x-ga-measurement_id': 'G-123ABC',\n    'x-ga-gtm_version': '45je55e1za200',\n\
  \    'x-ga-page_id': 1747422523211,\n    'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa':\
  \ '0',\n    'x-ga-dma': '0',\n    'x-ga-mp2-tag_exp':\n      '101509157~103116025~103130498~103130500~103136993~103136995~103200001~103207802~103211513~103233427~103252644~103252646~103263073~103301114~103301116',\n\
  \    client_id: 'AUJctU7H7hBB/aMuhE4pKwGu5DWDdklg5abyyyn8i/I=.1747154479',\n   \
  \ 'x-ga-ecid': '1294673677',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    event_id: '101509157~103116025~103130498',\n\
  \    timestamp: 1748377016,\n    client_hints: {\n      architecture: 'arm',\n \
  \     bitness: '64',\n      full_version_list: [\n        { brand: 'Chromium', version:\
  \ '136.0.7103.93' },\n        { brand: 'Google Chrome', version: '136.0.7103.93'\
  \ },\n        { brand: 'Not.A/Brand', version: '99.0.0.0' }\n      ],\n      mobile:\
  \ false,\n      model: '',\n      platform: 'macOS',\n      platform_version: '15.2.0',\n\
  \      wow64: false,\n      brands: [\n        { brand: 'Chromium', version: '136'\
  \ },\n        { brand: 'Google Chrome', version: '136' },\n        { brand: 'Not.A/Brand',\
  \ version: '99' }\n      ]\n    },\n    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n\
  \    'x-ga-pscdl': 'noapi',\n    'x-ga-system_properties': { eu: [34], tu: 'BA',\
  \ ss: '1', ee: true },\n    'x-sst-system_properties': {\n      etld: 'google.com.br',\n\
  \      tft: '1747422523211',\n      lpc: '60493049',\n      navt: 'r',\n      ude:\
  \ '0',\n      sw_exp: '1',\n      request_start_time_ms: 1747422524851\n    },\n\
  \    'x-ga-request_count': 1,\n    ga_session_id: '1747422523',\n    ga_session_number:\
  \ 3,\n    'x-ga-mp2-seg': '0',\n    page_location: 'https://example.com/?test=1i23i21j3',\n\
  \    page_title: 'Example Domain',\n    event_name: 'page_view',\n    'x-ga-tfd':\
  \ 5784,\n    ip_override: '2804:14d:c096:8dd6:311c:8c00:e6c:e33',\n    user_agent:\n\
  \      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML,\
  \ like Gecko) Chrome/136.0.0.0 Safari/537.36',\n    value: 123.45,\n    currency:\
  \ 'BRL',\n    user_data: {\n      email: { 0: 'test1@example.net', 1: 'test2@example.org'\
  \ },\n      phone_number: '+55 (19) 99999-9999',\n      address: {\n        first_name:\
  \ 'test',\n        last_name: 'test',\n        postal_code: '10001',\n        country:\
  \ 'BR'\n      }\n    }\n  }, objToBeMerged || {}));\n};\n\nmock('sendHttpRequest',\
  \ (requestUrl, callback, requestOptions, requestBody) => {\n  if (typeof callback\
  \ === 'function') {\n    callback(200);\n  } else {\n    requestBody = requestOptions;\n\
  \    requestOptions = callback;\n    return Promise.create((resolve, reject) =>\
  \ {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nmock('getRequestHeader',\
  \ (header) => {\n  if (header === 'trace-id') return 'expectedTraceId';\n});\n\n\
  mock('getTimestampMillis', 1747945830456);"


___NOTES___

Created on 7/17/2025, 5:44:02 PM

